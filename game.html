<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>アメーバ・シティ - あなたの街を守ろう！</title>

  <!-- OGP Meta Tags -->
  <meta property="og:title" content="アメーバ・シティ - あなたの街を守ろう！">
  <meta property="og:description" content="12万体のゆるキャラで日本を防衛するゲーム。都道府県ランキングで1位を目指せ！">
  <meta property="og:image" content="https://img.mascodex.com/game-ogp.png">
  <meta property="og:url" content="https://mascodex.com/game.html">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="アメーバ・シティ - あなたの街を守ろう！">
  <meta name="twitter:description" content="12万体のゆるキャラで日本を防衛するゲーム。都道府県ランキングで1位を目指せ！">
  <meta name="twitter:image" content="https://img.mascodex.com/game-ogp.png">

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ── Header ─────────────────────────────────── */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      background: rgba(255,255,255,0.04);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-title {
      font-size: 1.25rem;
      font-weight: 700;
      background: linear-gradient(135deg, #e94560, #ff6b81);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 0.04em;
    }
    .header-nav { display: flex; gap: 16px; align-items: center; }
    .header-nav a {
      color: rgba(255,255,255,0.65);
      text-decoration: none;
      font-size: 0.85rem;
      transition: color 0.2s;
    }
    .header-nav a:hover { color: #fff; }

    /* ── Main Layout ────────────────────────────── */
    .main-grid {
      display: grid;
      grid-template-columns: 260px 1fr;
      grid-template-rows: 1fr auto;
      gap: 0;
      min-height: calc(100vh - 56px);
    }

    /* ── Rankings Sidebar ───────────────────────── */
    .rankings-sidebar {
      grid-row: 1 / 3;
      background: rgba(255,255,255,0.03);
      border-right: 1px solid rgba(255,255,255,0.06);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .rankings-header {
      padding: 16px;
      font-size: 0.95rem;
      font-weight: 600;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.9);
      flex-shrink: 0;
    }
    .rankings-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    .rankings-list::-webkit-scrollbar { width: 4px; }
    .rankings-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }

    .rank-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      cursor: pointer;
      transition: background 0.15s;
      font-size: 0.85rem;
    }
    .rank-item:hover { background: rgba(255,255,255,0.06); }
    .rank-item.active { background: rgba(233,69,96,0.15); }

    .rank-num {
      width: 24px;
      text-align: right;
      font-weight: 700;
      color: rgba(255,255,255,0.5);
      font-size: 0.8rem;
    }
    .rank-item:nth-child(1) .rank-num { color: #ffd700; }
    .rank-item:nth-child(2) .rank-num { color: #c0c0c0; }
    .rank-item:nth-child(3) .rank-num { color: #cd7f32; }

    .rank-name { flex: 1; }
    .rank-change {
      font-size: 0.75rem;
      font-weight: 600;
      min-width: 28px;
      text-align: right;
    }
    .rank-change.up { color: #4caf50; }
    .rank-change.down { color: #f44336; }
    .rank-change.same { color: rgba(255,255,255,0.25); }

    .rank-score {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.4);
      min-width: 36px;
      text-align: right;
    }

    /* ── Map Area ───────────────────────────────── */
    .map-area {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      overflow: hidden;
    }

    .japan-map-container {
      position: relative;
      width: 100%;
      max-width: 560px;
    }

    .japan-map-container svg { width: 100%; height: auto; }

    .pref-rect {
      stroke: rgba(255,255,255,0.15);
      stroke-width: 1;
      cursor: pointer;
      transition: opacity 0.2s, stroke-width 0.15s;
    }
    .pref-rect:hover {
      opacity: 0.85;
      stroke: #fff;
      stroke-width: 2;
    }
    .pref-rect.selected {
      stroke: #e94560;
      stroke-width: 2.5;
    }

    .pref-label {
      font-size: 7px;
      fill: rgba(255,255,255,0.85);
      pointer-events: none;
      text-anchor: middle;
      dominant-baseline: central;
      font-weight: 600;
    }

    /* Amoeba dots on map */
    .amoeba-dot {
      animation: amoebaPulse 2s ease-in-out infinite;
    }
    @keyframes amoebaPulse {
      0%, 100% { r: 4; opacity: 0.8; }
      50% { r: 7; opacity: 0.4; }
    }

    /* Prefecture detail tooltip */
    .pref-detail-panel {
      position: absolute;
      right: 24px;
      top: 24px;
      width: 260px;
      background: rgba(20,20,40,0.92);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      display: none;
      z-index: 10;
    }
    .pref-detail-panel.visible { display: block; }
    .pref-detail-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 12px;
    }
    .pref-detail-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      padding: 4px 0;
      color: rgba(255,255,255,0.7);
    }
    .pref-detail-row span:last-child { color: #fff; font-weight: 600; }
    .pref-detail-close {
      position: absolute;
      top: 12px;
      right: 14px;
      background: none;
      border: none;
      color: rgba(255,255,255,0.5);
      font-size: 1.1rem;
      cursor: pointer;
    }
    .pref-detail-close:hover { color: #fff; }

    .hp-bar-container {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
      margin: 8px 0;
    }
    .hp-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.6s ease, background-color 0.6s ease;
    }

    /* Map legend */
    .map-legend {
      position: absolute;
      bottom: 16px;
      left: 24px;
      display: flex;
      gap: 12px;
      font-size: 0.72rem;
      color: rgba(255,255,255,0.55);
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-swatch {
      width: 12px;
      height: 8px;
      border-radius: 2px;
    }

    /* Active amoeba count badge */
    .amoeba-badge {
      position: absolute;
      top: 16px;
      left: 24px;
      background: rgba(233,69,96,0.2);
      border: 1px solid rgba(233,69,96,0.4);
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .amoeba-badge-dot {
      width: 8px;
      height: 8px;
      background: #e94560;
      border-radius: 50%;
      animation: amoebaBadgePulse 1.5s ease-in-out infinite;
    }
    @keyframes amoebaBadgePulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* ── Bottom Panel ───────────────────────────── */
    .bottom-panel {
      background: rgba(255,255,255,0.04);
      border-top: 1px solid rgba(255,255,255,0.08);
      padding: 20px 24px;
      display: flex;
      align-items: center;
      gap: 24px;
    }

    /* Character display */
    .character-section {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
    }
    .character-img-wrap {
      width: 72px;
      height: 72px;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid rgba(255,255,255,0.15);
      flex-shrink: 0;
    }
    .character-img-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .character-info { font-size: 0.85rem; }
    .character-name { font-weight: 700; margin-bottom: 2px; }
    .character-level {
      color: rgba(255,255,255,0.5);
      font-size: 0.78rem;
      margin-bottom: 6px;
    }
    .character-xp-bar {
      width: 120px;
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      overflow: hidden;
    }
    .character-xp-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    .character-district {
      font-size: 0.78rem;
      color: rgba(255,255,255,0.5);
    }
    .character-district-hp {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }
    .district-hp-bar {
      width: 100px;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    .district-hp-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.6s ease, background-color 0.6s ease;
    }
    .district-hp-text {
      font-size: 0.72rem;
      color: rgba(255,255,255,0.5);
    }

    /* Divider */
    .panel-divider {
      width: 1px;
      height: 48px;
      background: rgba(255,255,255,0.1);
      flex-shrink: 0;
    }

    /* Action buttons */
    .actions-section {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    .action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s, transform 0.1s;
      white-space: nowrap;
      font-family: inherit;
    }
    .action-btn:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.2);
    }
    .action-btn:active { transform: scale(0.97); }
    .action-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .action-btn.primary {
      background: linear-gradient(135deg, #e94560, #c0392b);
      border-color: transparent;
    }
    .action-btn.primary:hover {
      background: linear-gradient(135deg, #ff5a75, #e94560);
    }
    .action-icon { font-size: 1.1rem; }

    /* Notification toast */
    .toast-container {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 200;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }
    .toast {
      background: rgba(20,20,40,0.95);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 0.85rem;
      animation: toastIn 0.3s ease, toastOut 0.3s ease 2.5s forwards;
      max-width: 360px;
      text-align: center;
    }
    .toast.success { border-color: rgba(76,175,80,0.5); }
    .toast.error { border-color: rgba(244,67,54,0.5); }
    .toast.info { border-color: rgba(33,150,243,0.5); }

    @keyframes toastIn {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes toastOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-12px); }
    }

    /* ── Character CSS States ───────────────────── */
    .char-healthy { /* default */ }
    .char-anxious { animation: tremble 0.3s infinite; filter: saturate(0.8); }
    .char-pain { filter: grayscale(30%) brightness(0.85); }
    .char-dark { filter: hue-rotate(180deg) brightness(0.5) contrast(1.3); }
    .char-fallen { filter: grayscale(100%) brightness(0.3); opacity: 0.7; }
    .char-evolved { filter: brightness(1.2) saturate(1.5); box-shadow: 0 0 30px rgba(255,215,0,0.8); }

    @keyframes tremble {
      0%, 100% { transform: translateX(0); }
      50% { transform: translateX(2px); }
    }

    /* ── Quiz Modal ─────────────────────────────── */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 300;
    }
    .modal-overlay.visible {
      display: flex;
    }
    .modal-card {
      background: linear-gradient(145deg, #1e1e3a, #16213e);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 32px;
      max-width: 480px;
      width: 90%;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      color: rgba(255,255,255,0.5);
      font-size: 1.2rem;
      cursor: pointer;
    }
    .modal-close:hover { color: #fff; }
    .modal-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 20px;
      text-align: center;
    }
    .quiz-question {
      font-size: 1rem;
      line-height: 1.6;
      margin-bottom: 20px;
      padding: 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
    }
    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .quiz-option-btn {
      padding: 12px 16px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s, transform 0.1s;
      text-align: left;
      font-family: inherit;
    }
    .quiz-option-btn:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.2);
    }
    .quiz-option-btn:active { transform: scale(0.98); }
    .quiz-option-btn.correct {
      background: rgba(76,175,80,0.25);
      border-color: #4caf50;
    }
    .quiz-option-btn.wrong {
      background: rgba(244,67,54,0.2);
      border-color: #f44336;
    }
    .quiz-option-btn:disabled { cursor: default; opacity: 0.7; }

    .quiz-result {
      text-align: center;
      padding: 16px;
      font-size: 0.95rem;
      display: none;
    }
    .quiz-result.visible { display: block; }
    .quiz-result-icon { font-size: 2.5rem; margin-bottom: 8px; }
    .quiz-result-hp {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      margin-top: 4px;
    }

    /* ── Share Panel ─────────────────────────────── */
    .share-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(20,20,40,0.97);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-top: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px 16px 0 0;
      padding: 24px;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 250;
    }
    .share-panel.visible { transform: translateY(0); }
    .share-panel-title {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 16px;
      text-align: center;
    }
    .share-buttons {
      display: flex;
      justify-content: center;
      gap: 16px;
    }
    .share-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.1s;
      color: #fff;
      font-family: inherit;
    }
    .share-btn:hover { opacity: 0.9; }
    .share-btn:active { transform: scale(0.97); }
    .share-btn.twitter { background: #1da1f2; }
    .share-btn.line { background: #06c755; }
    .share-panel-close {
      display: block;
      margin: 16px auto 0;
      background: none;
      border: none;
      color: rgba(255,255,255,0.5);
      font-size: 0.85rem;
      cursor: pointer;
      font-family: inherit;
    }
    .share-panel-close:hover { color: #fff; }

    /* ── Registration / Login Gate ───────────────── */
    .gate-overlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 500;
    }
    .gate-overlay.hidden { display: none; }
    .gate-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 40px;
      max-width: 420px;
      width: 90%;
      text-align: center;
    }
    .gate-title {
      font-size: 1.6rem;
      font-weight: 700;
      background: linear-gradient(135deg, #e94560, #ff6b81);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 12px;
    }
    .gate-subtitle {
      color: rgba(255,255,255,0.6);
      font-size: 0.9rem;
      margin-bottom: 32px;
      line-height: 1.5;
    }
    .gate-input {
      display: block;
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      background: rgba(255,255,255,0.06);
      color: #fff;
      font-size: 0.95rem;
      margin-bottom: 12px;
      outline: none;
      font-family: inherit;
      text-align: center;
      letter-spacing: 0.15em;
    }
    .gate-input::placeholder {
      color: rgba(255,255,255,0.3);
      letter-spacing: 0.05em;
    }
    .gate-input:focus {
      border-color: rgba(233,69,96,0.5);
    }
    .gate-btn {
      display: inline-block;
      padding: 12px 32px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #e94560, #c0392b);
      color: #fff;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
      font-family: inherit;
    }
    .gate-btn:hover { opacity: 0.9; }
    .gate-btn:active { transform: scale(0.97); }
    .gate-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .gate-link {
      color: rgba(255,255,255,0.5);
      font-size: 0.85rem;
      margin-top: 16px;
    }
    .gate-link a {
      color: #e94560;
      text-decoration: none;
    }
    .gate-link a:hover { text-decoration: underline; }
    .gate-error {
      color: #f44336;
      font-size: 0.82rem;
      margin-top: 8px;
      min-height: 1.2em;
    }

    /* ── Loading Spinner ────────────────────────── */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.2);
      border-top-color: #e94560;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ── Mobile Responsive ──────────────────────── */
    @media (max-width: 860px) {
      .main-grid {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
      }
      .rankings-sidebar {
        grid-row: 1;
        border-right: none;
        border-bottom: 1px solid rgba(255,255,255,0.06);
        max-height: none;
      }
      .rankings-list {
        display: flex;
        overflow-x: auto;
        overflow-y: hidden;
        padding: 8px 12px;
        gap: 4px;
      }
      .rankings-list::-webkit-scrollbar { height: 3px; }
      .rank-item {
        flex-shrink: 0;
        padding: 6px 12px;
        border-radius: 8px;
        background: rgba(255,255,255,0.04);
        min-width: 100px;
        font-size: 0.78rem;
      }
      .map-area {
        padding: 16px;
      }
      .pref-detail-panel {
        position: fixed;
        left: 16px;
        right: 16px;
        bottom: 100px;
        top: auto;
        width: auto;
      }
      .bottom-panel {
        flex-wrap: wrap;
        gap: 12px;
        padding: 16px;
      }
      .character-section { width: 100%; }
      .panel-divider { display: none; }
      .actions-section {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
      }
      .action-btn {
        flex: 1;
        min-width: 0;
        justify-content: center;
        padding: 10px 12px;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      .header { padding: 12px 16px; }
      .header-title { font-size: 1.05rem; }
      .map-area { padding: 8px; }
      .pref-label { font-size: 5.5px; }
    }
  </style>
</head>
<body>

  <!-- ── Header ──────────────────────────────────── -->
  <header class="header">
    <div class="header-title">アメーバ・シティ</div>
    <nav class="header-nav">
      <a href="index.html">ホーム</a>
      <a href="game.html">ゲーム</a>
    </nav>
  </header>

  <!-- ── Login Gate ──────────────────────────────── -->
  <div id="loginGate" class="gate-overlay">
    <div class="gate-card">
      <div class="gate-title">アメーバ・シティ</div>
      <div class="gate-subtitle">ログインしてからゲームに参加できます</div>
      <a href="index.html" class="gate-btn" style="text-decoration:none;">ログインページへ</a>
    </div>
  </div>

  <!-- ── Registration Gate ───────────────────────── -->
  <div id="registerGate" class="gate-overlay hidden">
    <div class="gate-card">
      <div class="gate-title">ゲーム登録</div>
      <div class="gate-subtitle">あなたの郵便番号でキャラと地区が決まります。<br>どの街を守る？</div>
      <input type="text" id="postalCodeInput" class="gate-input" placeholder="郵便番号 (例: 1000001)" maxlength="8" inputmode="numeric">
      <div class="gate-error" id="registerError"></div>
      <button class="gate-btn" id="registerBtn" onclick="registerPlayer()">参戦する</button>
    </div>
  </div>

  <!-- ── Main Game UI ────────────────────────────── -->
  <div class="main-grid" id="gameUI" style="display:none;">

    <!-- Rankings Sidebar -->
    <aside class="rankings-sidebar">
      <div class="rankings-header">都道府県ランキング</div>
      <div class="rankings-list" id="rankingsList">
        <!-- Populated by JS -->
      </div>
    </aside>

    <!-- Map Area -->
    <main class="map-area">
      <div class="amoeba-badge" id="amoebaBadge">
        <div class="amoeba-badge-dot"></div>
        <span id="amoebaCountText">アメーバ: 0体</span>
      </div>

      <div class="japan-map-container">
        <svg id="japanMap" viewBox="0 0 380 700" xmlns="http://www.w3.org/2000/svg">
          <!-- 47 Prefectures rendered as rects in a stylized Japan shape -->
          <!-- Will be generated by JS for clean coordinate management -->
        </svg>
      </div>

      <!-- Prefecture Detail Panel -->
      <div class="pref-detail-panel" id="prefDetailPanel">
        <button class="pref-detail-close" onclick="closePrefDetail()">&times;</button>
        <div class="pref-detail-title" id="prefDetailTitle">-</div>
        <div class="hp-bar-container">
          <div class="hp-bar-fill" id="prefDetailHpBar" style="width:100%;background:#4caf50;"></div>
        </div>
        <div class="pref-detail-row"><span>平均HP</span><span id="prefDetailHp">-</span></div>
        <div class="pref-detail-row"><span>侵食率</span><span id="prefDetailInfection">-</span></div>
        <div class="pref-detail-row"><span>プレイヤー</span><span id="prefDetailPlayers">-</span></div>
        <div class="pref-detail-row"><span>感染地区</span><span id="prefDetailInfected">-</span></div>
      </div>

      <!-- Map Legend -->
      <div class="map-legend">
        <div class="legend-item"><div class="legend-swatch" style="background:#4caf50;"></div>安全</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#ff9800;"></div>注意</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#f44336;"></div>危険</div>
        <div class="legend-item"><div class="legend-swatch" style="background:#880e4f;"></div>壊滅</div>
      </div>
    </main>

    <!-- Bottom Panel -->
    <div class="bottom-panel" style="grid-column: 1 / -1;">
      <!-- Character Display -->
      <div class="character-section">
        <div class="character-img-wrap" id="characterImgWrap">
          <img id="characterImg" src="" alt="キャラクター" onerror="this.style.display='none'">
        </div>
        <div>
          <div class="character-info">
            <div class="character-name" id="charName">-</div>
            <div class="character-level" id="charLevel">Lv.1</div>
            <div class="character-xp-bar">
              <div class="character-xp-fill" id="charXpFill" style="width:0%"></div>
            </div>
          </div>
          <div class="character-district" id="charDistrict">-</div>
          <div class="character-district-hp">
            <div class="district-hp-bar">
              <div class="district-hp-fill" id="districtHpFill" style="width:100%;background:#4caf50;"></div>
            </div>
            <span class="district-hp-text" id="districtHpText">100/100</span>
          </div>
        </div>
      </div>

      <div class="panel-divider"></div>

      <!-- Action Buttons -->
      <div class="actions-section">
        <button class="action-btn primary" id="loginBonusBtn" onclick="claimLoginBonus()">
          <span class="action-icon">&#x1F381;</span> ログインボーナス
        </button>
        <button class="action-btn" id="quizBtn" onclick="openQuiz()">
          <span class="action-icon">&#x2753;</span> クイズに挑戦
        </button>
        <button class="action-btn" id="shareBtn" onclick="openSharePanel()">
          <span class="action-icon">&#x1F4E2;</span> シェアして防衛
        </button>
      </div>
    </div>
  </div>

  <!-- ── Quiz Modal ──────────────────────────────── -->
  <div class="modal-overlay" id="quizModal">
    <div class="modal-card">
      <button class="modal-close" onclick="closeQuiz()">&times;</button>
      <div class="modal-title" id="quizModalTitle">ご当地クイズ</div>
      <div class="quiz-question" id="quizQuestion">読み込み中...</div>
      <div class="quiz-options" id="quizOptions">
        <!-- Populated by JS -->
      </div>
      <div class="quiz-result" id="quizResult">
        <div class="quiz-result-icon" id="quizResultIcon"></div>
        <div id="quizResultText"></div>
        <div class="quiz-result-hp" id="quizResultHp"></div>
      </div>
    </div>
  </div>

  <!-- ── Share Panel ─────────────────────────────── -->
  <div class="share-panel" id="sharePanel">
    <div class="share-panel-title">SNSでシェアして防衛力UP！</div>
    <div class="share-buttons">
      <button class="share-btn twitter" onclick="shareTwitter()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        Xで共有
      </button>
      <button class="share-btn line" onclick="shareLine()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 5.82 2 10.5c0 3.12 2.24 5.83 5.47 7.15-.08.3-.48 1.82-.55 2.1-.08.35.13.34.27.25.11-.07 1.72-1.14 2.43-1.6.78.11 1.58.17 2.38.17 5.52 0 10-3.82 10-8.5S17.52 2 12 2z"/></svg>
        LINEで共有
      </button>
    </div>
    <button class="share-panel-close" onclick="closeSharePanel()">閉じる</button>
  </div>

  <!-- ── Toast Container ─────────────────────────── -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    /* ═════════════════════════════════════════════════
       Constants & State
       ═════════════════════════════════════════════════ */
    const API_BASE = '';  // same origin (Cloudflare Pages Functions)
    let authToken = null;
    let playerData = null;
    let districtData = null;
    let gameState = null;  // { prefectures: [...] }
    let rankingsData = null;
    let amoebasData = null;
    let currentQuizId = null;
    let refreshInterval = null;

    // Prefecture data: code(01-47), name, grid position (col, row)
    const PREFECTURES = [
      { code: '01', name: '北海道',   col: 8, row: 0 },
      { code: '02', name: '青森県',   col: 7, row: 2 },
      { code: '03', name: '岩手県',   col: 8, row: 3 },
      { code: '04', name: '宮城県',   col: 8, row: 4 },
      { code: '05', name: '秋田県',   col: 7, row: 3 },
      { code: '06', name: '山形県',   col: 7, row: 4 },
      { code: '07', name: '福島県',   col: 7, row: 5 },
      { code: '08', name: '茨城県',   col: 8, row: 6 },
      { code: '09', name: '栃木県',   col: 7, row: 6 },
      { code: '10', name: '群馬県',   col: 6, row: 6 },
      { code: '11', name: '埼玉県',   col: 7, row: 7 },
      { code: '12', name: '千葉県',   col: 8, row: 7 },
      { code: '13', name: '東京都',   col: 7, row: 8 },
      { code: '14', name: '神奈川県', col: 7, row: 9 },
      { code: '15', name: '新潟県',   col: 6, row: 5 },
      { code: '16', name: '富山県',   col: 5, row: 6 },
      { code: '17', name: '石川県',   col: 5, row: 7 },
      { code: '18', name: '福井県',   col: 4, row: 8 },
      { code: '19', name: '山梨県',   col: 6, row: 8 },
      { code: '20', name: '長野県',   col: 6, row: 7 },
      { code: '21', name: '岐阜県',   col: 5, row: 8 },
      { code: '22', name: '静岡県',   col: 6, row: 9 },
      { code: '23', name: '愛知県',   col: 5, row: 9 },
      { code: '24', name: '三重県',   col: 5, row: 10 },
      { code: '25', name: '滋賀県',   col: 4, row: 9 },
      { code: '26', name: '京都府',   col: 4, row: 10 },
      { code: '27', name: '大阪府',   col: 4, row: 11 },
      { code: '28', name: '兵庫県',   col: 3, row: 10 },
      { code: '29', name: '奈良県',   col: 5, row: 11 },
      { code: '30', name: '和歌山県', col: 4, row: 12 },
      { code: '31', name: '鳥取県',   col: 3, row: 11 },
      { code: '32', name: '島根県',   col: 2, row: 11 },
      { code: '33', name: '岡山県',   col: 3, row: 12 },
      { code: '34', name: '広島県',   col: 2, row: 12 },
      { code: '35', name: '山口県',   col: 1, row: 12 },
      { code: '36', name: '徳島県',   col: 4, row: 13 },
      { code: '37', name: '香川県',   col: 3, row: 13 },
      { code: '38', name: '愛媛県',   col: 2, row: 13 },
      { code: '39', name: '高知県',   col: 3, row: 14 },
      { code: '40', name: '福岡県',   col: 1, row: 14 },
      { code: '41', name: '佐賀県',   col: 0, row: 14 },
      { code: '42', name: '長崎県',   col: 0, row: 15 },
      { code: '43', name: '熊本県',   col: 1, row: 15 },
      { code: '44', name: '大分県',   col: 2, row: 14 },
      { code: '45', name: '宮崎県',   col: 2, row: 15 },
      { code: '46', name: '鹿児島県', col: 1, row: 16 },
      { code: '47', name: '沖縄県',   col: 0, row: 18 },
    ];

    // Short name for map labels (remove 県/都/府/道)
    function shortName(name) {
      return name.replace(/[県都府道]$/, '');
    }

    // Prefecture code → name mapping
    const PREF_CODE_TO_NAME = {};
    const PREF_NAME_TO_CODE = {};
    PREFECTURES.forEach(p => {
      PREF_CODE_TO_NAME[p.code] = p.name;
      PREF_NAME_TO_CODE[p.name] = p.code;
    });

    /* ═════════════════════════════════════════════════
       Initialization
       ═════════════════════════════════════════════════ */
    document.addEventListener('DOMContentLoaded', init);

    async function init() {
      // Check both possible token keys for compatibility
      authToken = localStorage.getItem('mascodex_token') || localStorage.getItem('userToken');

      if (!authToken) {
        showLoginGate();
        return;
      }

      hideLoginGate();
      await checkPlayerRegistration();
    }

    function showLoginGate() {
      document.getElementById('loginGate').classList.remove('hidden');
      document.getElementById('registerGate').classList.add('hidden');
      document.getElementById('gameUI').style.display = 'none';
    }

    function hideLoginGate() {
      document.getElementById('loginGate').classList.add('hidden');
    }

    async function checkPlayerRegistration() {
      try {
        const res = await apiFetch('/api/game/player/me');
        if (res.success && res.registered) {
          playerData = res.player;
          districtData = res.district;
          hideLoginGate();
          document.getElementById('registerGate').classList.add('hidden');
          showGameUI(res);
        } else {
          // Not registered yet, show postal code input
          hideLoginGate();
          document.getElementById('registerGate').classList.remove('hidden');
          document.getElementById('gameUI').style.display = 'none';
        }
      } catch (err) {
        console.error('Failed to check player:', err);
        // If 401, token is invalid
        showLoginGate();
      }
    }

    async function registerPlayer() {
      const input = document.getElementById('postalCodeInput');
      const errEl = document.getElementById('registerError');
      const btn = document.getElementById('registerBtn');
      const raw = input.value.replace(/[^0-9]/g, '');

      if (raw.length !== 7) {
        errEl.textContent = '7桁の郵便番号を入力してください';
        return;
      }

      btn.disabled = true;
      btn.textContent = '登録中...';
      errEl.textContent = '';

      try {
        const res = await apiFetch('/api/game/register', {
          method: 'POST',
          body: JSON.stringify({ postalCode: raw }),
        });

        if (res.success) {
          playerData = res.player;
          districtData = res.district;
          document.getElementById('registerGate').classList.add('hidden');
          showGameUI({
            player: res.player,
            district: res.district,
            element: res.element,
            region: res.region,
            characterImage: `https://img.mascodex.com/${raw}_01.png`,
          });
          showToast('参戦完了！あなたの街を守ろう！', 'success');
        } else {
          errEl.textContent = res.error || '登録に失敗しました';
        }
      } catch (err) {
        console.error('Registration error:', err);
        errEl.textContent = 'サーバーエラーが発生しました';
      } finally {
        btn.disabled = false;
        btn.textContent = '参戦する';
      }
    }

    /* ═════════════════════════════════════════════════
       Show Game UI
       ═════════════════════════════════════════════════ */
    async function showGameUI(profileRes) {
      document.getElementById('gameUI').style.display = '';

      // Render Japan map SVG
      renderJapanMap();

      // Update character display
      updateCharacterDisplay(profileRes);

      // Load data in parallel
      await Promise.all([
        loadGameState(),
        loadRankings(),
        loadAmoebas(),
      ]);

      // Start auto-refresh
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(async () => {
        await Promise.all([loadGameState(), loadRankings(), loadAmoebas()]);
      }, 60000);
    }

    /* ═════════════════════════════════════════════════
       Japan SVG Map Rendering
       ═════════════════════════════════════════════════ */
    function renderJapanMap() {
      const svg = document.getElementById('japanMap');
      svg.innerHTML = '';  // clear

      const cellW = 40;
      const cellH = 35;
      const padX = 10;
      const padY = 10;

      PREFECTURES.forEach(pref => {
        const x = padX + pref.col * cellW;
        const y = padY + pref.row * cellH;

        // Rectangle for prefecture
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('id', `pref-${pref.code}`);
        rect.setAttribute('class', 'pref-rect');
        rect.setAttribute('x', x);
        rect.setAttribute('y', y);
        rect.setAttribute('width', cellW - 2);
        rect.setAttribute('height', cellH - 2);
        rect.setAttribute('rx', '3');
        rect.setAttribute('fill', '#4caf50');
        rect.setAttribute('data-code', pref.code);
        rect.setAttribute('data-name', pref.name);
        rect.addEventListener('click', () => onPrefClick(pref));
        svg.appendChild(rect);

        // Text label
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('class', 'pref-label');
        text.setAttribute('x', x + (cellW - 2) / 2);
        text.setAttribute('y', y + (cellH - 2) / 2);
        text.textContent = shortName(pref.name);
        svg.appendChild(text);
      });
    }

    /* ═════════════════════════════════════════════════
       Data Loading
       ═════════════════════════════════════════════════ */
    async function loadGameState() {
      try {
        const res = await apiFetch('/api/game/state', { method: 'GET', noAuth: true });
        if (!res.success) return;
        gameState = res;
        updateMapColors(res.prefectures);
        document.getElementById('amoebaCountText').textContent = `アメーバ: ${res.activeAmoebas}体`;
      } catch (err) {
        console.error('Failed to load game state:', err);
      }
    }

    async function loadRankings() {
      try {
        const res = await apiFetch('/api/game/ranking/prefectures', { method: 'GET', noAuth: true });
        if (!res.success) return;
        rankingsData = res.rankings;
        renderRankings(res.rankings);
      } catch (err) {
        console.error('Failed to load rankings:', err);
      }
    }

    async function loadAmoebas() {
      try {
        const res = await apiFetch('/api/game/amoebas', { method: 'GET', noAuth: true });
        if (!res.success) return;
        amoebasData = res.amoebas;
        renderAmoebasOnMap(res.amoebas);
      } catch (err) {
        console.error('Failed to load amoebas:', err);
      }
    }

    /* ═════════════════════════════════════════════════
       Map Color Update
       ═════════════════════════════════════════════════ */
    function hpToColor(avgHp) {
      // avgHp is 0-100
      if (avgHp >= 75) return '#4caf50';   // green - safe
      if (avgHp >= 50) return '#ff9800';   // orange - caution
      if (avgHp >= 25) return '#f44336';   // red - danger
      return '#880e4f';                     // dark red - critical
    }

    function updateMapColors(prefectures) {
      if (!prefectures) return;
      prefectures.forEach(p => {
        const code = PREF_NAME_TO_CODE[p.prefecture];
        if (!code) return;
        const rect = document.getElementById(`pref-${code}`);
        if (rect) {
          rect.setAttribute('fill', hpToColor(p.avgHp));
        }
      });
    }

    /* ═════════════════════════════════════════════════
       Amoeba Visualization on Map
       ═════════════════════════════════════════════════ */
    function renderAmoebasOnMap(amoebas) {
      // Remove existing amoeba dots
      document.querySelectorAll('.amoeba-dot').forEach(el => el.remove());

      const svg = document.getElementById('japanMap');
      const cellW = 40;
      const cellH = 35;
      const padX = 10;
      const padY = 10;

      // Build a map from district prefix to affected prefectures
      amoebas.forEach(amoeba => {
        // Amoeba has currentDistricts: array of 3-digit codes
        // We need to map these to prefectures on the map
        // For simplicity, place a pulsing dot on the origin district's prefecture
        const originCode = amoeba.originDistrict;
        // Find which prefecture this district belongs to by checking gameState
        let prefCode = null;
        if (gameState && gameState.prefectures) {
          // We can't directly map district to prefecture from client side easily,
          // but we know the first digit(s) roughly map to prefecture codes.
          // Instead, let's put dots on affected districts by looking at the map more broadly.
          // For a visual approximation, we'll scatter amoeba dots across the map.
        }

        // Place a dot at a random position within the map area for each active amoeba
        // as a visual indicator. More precisely, if we knew the prefecture, we'd place it there.
        // For now, use a pseudo-random but deterministic position based on amoeba id
        const hash = hashString(amoeba.id || amoeba.name);
        const prefIdx = hash % PREFECTURES.length;
        const pref = PREFECTURES[prefIdx];
        const cx = padX + pref.col * cellW + (cellW - 2) / 2;
        const cy = padY + pref.row * cellH + (cellH - 2) / 2;

        const typeColors = {
          fire: '#ff5722',
          ice: '#03a9f4',
          poison: '#9c27b0',
          water: '#2196f3',
          thunder: '#ffeb3b',
        };

        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('class', 'amoeba-dot');
        circle.setAttribute('cx', cx);
        circle.setAttribute('cy', cy);
        circle.setAttribute('r', '5');
        circle.setAttribute('fill', typeColors[amoeba.type] || '#e94560');
        circle.setAttribute('opacity', '0.8');
        svg.appendChild(circle);
      });
    }

    function hashString(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash);
    }

    /* ═════════════════════════════════════════════════
       Rankings Rendering
       ═════════════════════════════════════════════════ */
    function renderRankings(rankings) {
      const list = document.getElementById('rankingsList');
      if (!rankings || rankings.length === 0) {
        list.innerHTML = '<div style="padding:16px;color:rgba(255,255,255,0.4);font-size:0.85rem;">ランキングデータなし</div>';
        return;
      }

      list.innerHTML = rankings.map(r => {
        let changeStr = '';
        let changeClass = 'same';
        if (r.rankChange > 0) {
          changeStr = `&#9650;${r.rankChange}`;
          changeClass = 'up';
        } else if (r.rankChange < 0) {
          changeStr = `&#9660;${Math.abs(r.rankChange)}`;
          changeClass = 'down';
        } else {
          changeStr = '-';
        }

        const isMyPref = playerData && playerData.prefecture === r.prefecture;

        return `
          <div class="rank-item${isMyPref ? ' active' : ''}" onclick="onRankingClick('${r.prefecture}')">
            <span class="rank-num">${r.rank}</span>
            <span class="rank-name">${shortName(r.prefecture)}</span>
            <span class="rank-change ${changeClass}">${changeStr}</span>
            <span class="rank-score">${Math.round(r.totalScore)}</span>
          </div>
        `;
      }).join('');
    }

    function onRankingClick(prefName) {
      const code = PREF_NAME_TO_CODE[prefName];
      if (!code) return;
      const pref = PREFECTURES.find(p => p.code === code);
      if (pref) onPrefClick(pref);
    }

    /* ═════════════════════════════════════════════════
       Prefecture Click → Detail Panel
       ═════════════════════════════════════════════════ */
    function onPrefClick(pref) {
      // Highlight on map
      document.querySelectorAll('.pref-rect.selected').forEach(el => el.classList.remove('selected'));
      const rect = document.getElementById(`pref-${pref.code}`);
      if (rect) rect.classList.add('selected');

      // Fill detail panel with state data
      const panel = document.getElementById('prefDetailPanel');
      const prefState = gameState?.prefectures?.find(p => p.prefecture === pref.name);

      document.getElementById('prefDetailTitle').textContent = pref.name;

      if (prefState) {
        const avgHp = prefState.avgHp;
        const hpPct = Math.min(100, Math.max(0, avgHp));
        document.getElementById('prefDetailHp').textContent = `${avgHp}%`;
        document.getElementById('prefDetailInfection').textContent = `${Math.round(prefState.infectionRate * 100)}%`;
        document.getElementById('prefDetailPlayers').textContent = `${prefState.players}人`;
        document.getElementById('prefDetailInfected').textContent = `${prefState.infected}/${prefState.totalDistricts}`;

        const hpBar = document.getElementById('prefDetailHpBar');
        hpBar.style.width = hpPct + '%';
        hpBar.style.backgroundColor = hpToColor(avgHp);
      } else {
        document.getElementById('prefDetailHp').textContent = '-';
        document.getElementById('prefDetailInfection').textContent = '-';
        document.getElementById('prefDetailPlayers').textContent = '-';
        document.getElementById('prefDetailInfected').textContent = '-';
        document.getElementById('prefDetailHpBar').style.width = '0%';
      }

      panel.classList.add('visible');
    }

    function closePrefDetail() {
      document.getElementById('prefDetailPanel').classList.remove('visible');
      document.querySelectorAll('.pref-rect.selected').forEach(el => el.classList.remove('selected'));
    }

    /* ═════════════════════════════════════════════════
       Character Display
       ═════════════════════════════════════════════════ */
    function updateCharacterDisplay(profileRes) {
      if (!profileRes) return;

      const p = profileRes.player;
      const d = profileRes.district;
      const charImg = document.getElementById('characterImg');
      const imgWrap = document.getElementById('characterImgWrap');

      // Character image
      if (profileRes.characterImage) {
        charImg.src = profileRes.characterImage;
        charImg.style.display = '';
      }

      // Character state CSS class
      const status = d ? d.status : 'healthy';
      imgWrap.className = 'character-img-wrap char-' + status;

      // Character info
      document.getElementById('charName').textContent = profileRes.element
        ? `${profileRes.element}属性のキャラ`
        : 'キャラクター';
      document.getElementById('charLevel').textContent = `Lv.${p.level || 1}`;

      // XP bar
      if (p.currentXp !== undefined && p.nextLevelXp) {
        const xpPct = Math.round((p.currentXp / p.nextLevelXp) * 100);
        document.getElementById('charXpFill').style.width = xpPct + '%';
      }

      // District info
      if (d) {
        document.getElementById('charDistrict').textContent = `${d.name || d.code} (${p.prefecture || ''})`;
        const hpPct = Math.round((d.hp / d.maxHp) * 100);
        document.getElementById('districtHpFill').style.width = hpPct + '%';
        document.getElementById('districtHpFill').style.backgroundColor = hpToColor(hpPct);
        document.getElementById('districtHpText').textContent = `${d.hp}/${d.maxHp}`;
      }
    }

    /* ═════════════════════════════════════════════════
       Login Bonus
       ═════════════════════════════════════════════════ */
    async function claimLoginBonus() {
      const btn = document.getElementById('loginBonusBtn');
      btn.disabled = true;

      try {
        const res = await apiFetch('/api/game/action/login', { method: 'POST' });
        if (res.success) {
          showToast(`ログインボーナス獲得！ HP+${res.hpGiven} XP+${res.xpEarned} (${res.consecutiveDays}日連続)`, 'success');
          // Update district HP display
          if (res.district) {
            districtData = res.district;
            const hpPct = Math.round((res.district.hp / res.district.maxHp) * 100);
            document.getElementById('districtHpFill').style.width = hpPct + '%';
            document.getElementById('districtHpFill').style.backgroundColor = hpToColor(hpPct);
            document.getElementById('districtHpText').textContent = `${res.district.hp}/${res.district.maxHp}`;
          }
          // Refresh player data
          await refreshPlayerData();
        } else {
          if (res.alreadyClaimed) {
            showToast('今日のログインボーナスはもう受け取りました', 'info');
          } else {
            showToast(res.error || 'エラーが発生しました', 'error');
          }
        }
      } catch (err) {
        console.error('Login bonus error:', err);
        showToast('通信エラーが発生しました', 'error');
      } finally {
        btn.disabled = false;
      }
    }

    /* ═════════════════════════════════════════════════
       Quiz
       ═════════════════════════════════════════════════ */
    async function openQuiz() {
      const modal = document.getElementById('quizModal');
      const optionsEl = document.getElementById('quizOptions');
      const resultEl = document.getElementById('quizResult');

      // Reset
      optionsEl.innerHTML = '<div style="text-align:center;padding:20px;"><div class="loading-spinner"></div></div>';
      resultEl.classList.remove('visible');
      document.getElementById('quizQuestion').textContent = '読み込み中...';
      modal.classList.add('visible');

      try {
        const res = await apiFetch('/api/game/action/quiz', {
          method: 'POST',
          body: JSON.stringify({ action: 'get' }),
        });

        if (!res.success) {
          document.getElementById('quizQuestion').textContent = res.error || 'クイズを取得できませんでした';
          optionsEl.innerHTML = '';
          return;
        }

        currentQuizId = res.quizId;
        document.getElementById('quizModalTitle').textContent = `ご当地クイズ (残り${res.remaining}回)`;
        document.getElementById('quizQuestion').textContent = res.question;

        optionsEl.innerHTML = res.options.map((opt, i) => `
          <button class="quiz-option-btn" onclick="answerQuiz(${i})" data-index="${i}">${opt}</button>
        `).join('');

      } catch (err) {
        console.error('Quiz load error:', err);
        document.getElementById('quizQuestion').textContent = '通信エラーが発生しました';
        optionsEl.innerHTML = '';
      }
    }

    async function answerQuiz(answerIndex) {
      if (!currentQuizId) return;

      // Disable all buttons
      document.querySelectorAll('.quiz-option-btn').forEach(btn => btn.disabled = true);

      try {
        const res = await apiFetch('/api/game/action/quiz', {
          method: 'POST',
          body: JSON.stringify({
            action: 'answer',
            quizId: currentQuizId,
            answer: answerIndex,
          }),
        });

        if (!res.success) {
          showToast(res.error || 'エラーが発生しました', 'error');
          return;
        }

        // Highlight correct/wrong
        const buttons = document.querySelectorAll('.quiz-option-btn');
        buttons.forEach((btn, i) => {
          if (i === res.correctAnswer) btn.classList.add('correct');
          if (i === answerIndex && !res.correct) btn.classList.add('wrong');
        });

        // Show result
        const resultEl = document.getElementById('quizResult');
        const iconEl = document.getElementById('quizResultIcon');
        const textEl = document.getElementById('quizResultText');
        const hpEl = document.getElementById('quizResultHp');

        if (res.correct) {
          iconEl.textContent = '\u2B50';
          textEl.textContent = '正解！';
          let bonusText = '';
          if (res.bonusMultiplier > 1) bonusText = ` (属性ボーナス x${res.bonusMultiplier})`;
          hpEl.textContent = `HP +${res.hpGiven}  XP +${res.xpEarned}${bonusText}`;
        } else {
          iconEl.textContent = '\u274C';
          textEl.textContent = '不正解...';
          hpEl.textContent = '次は正解しよう！';
        }

        resultEl.classList.add('visible');
        currentQuizId = null;

        // Update district HP if provided
        if (res.district) {
          districtData = res.district;
          const hpPct = Math.round((res.district.hp / res.district.maxHp) * 100);
          document.getElementById('districtHpFill').style.width = hpPct + '%';
          document.getElementById('districtHpFill').style.backgroundColor = hpToColor(hpPct);
          document.getElementById('districtHpText').textContent = `${res.district.hp}/${res.district.maxHp}`;
        }

        // Auto close after 2.5 seconds
        setTimeout(() => {
          closeQuiz();
          refreshPlayerData();
        }, 2500);

      } catch (err) {
        console.error('Quiz answer error:', err);
        showToast('通信エラーが発生しました', 'error');
      }
    }

    function closeQuiz() {
      document.getElementById('quizModal').classList.remove('visible');
      currentQuizId = null;
    }

    /* ═════════════════════════════════════════════════
       Share
       ═════════════════════════════════════════════════ */
    function openSharePanel() {
      document.getElementById('sharePanel').classList.add('visible');
    }

    function closeSharePanel() {
      document.getElementById('sharePanel').classList.remove('visible');
    }

    function getShareText() {
      const pref = playerData?.prefecture || '日本';
      let infectionRate = '??';
      if (gameState?.prefectures) {
        const prefState = gameState.prefectures.find(p => p.prefecture === pref);
        if (prefState) infectionRate = Math.round(prefState.infectionRate * 100);
      }
      return `「${pref}が${infectionRate}%侵食されてる！助けて！ #アメーバシティ #mascodex」`;
    }

    function shareTwitter() {
      const text = encodeURIComponent(getShareText());
      const url = encodeURIComponent('https://mascodex.com/game.html');
      window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
      recordShareAction();
    }

    function shareLine() {
      const text = encodeURIComponent(getShareText());
      const url = encodeURIComponent('https://mascodex.com/game.html');
      window.open(`https://social-plugins.line.me/lineit/share?url=${url}&text=${text}`, '_blank');
      recordShareAction();
    }

    async function recordShareAction() {
      closeSharePanel();
      try {
        const res = await apiFetch('/api/game/action/share', { method: 'POST' });
        if (res.success) {
          showToast(`シェアボーナス獲得！ HP+${res.hpGiven} XP+${res.xpEarned} (残り${res.remaining}回)`, 'success');
          if (res.district) {
            districtData = res.district;
            const hpPct = Math.round((res.district.hp / res.district.maxHp) * 100);
            document.getElementById('districtHpFill').style.width = hpPct + '%';
            document.getElementById('districtHpFill').style.backgroundColor = hpToColor(hpPct);
            document.getElementById('districtHpText').textContent = `${res.district.hp}/${res.district.maxHp}`;
          }
          await refreshPlayerData();
        } else {
          if (res.remaining === 0) {
            showToast('今日のシェア上限に達しました', 'info');
          } else {
            showToast(res.error || 'エラーが発生しました', 'error');
          }
        }
      } catch (err) {
        console.error('Share action error:', err);
      }
    }

    /* ═════════════════════════════════════════════════
       Refresh Player Data
       ═════════════════════════════════════════════════ */
    async function refreshPlayerData() {
      try {
        const res = await apiFetch('/api/game/player/me');
        if (res.success && res.registered) {
          playerData = res.player;
          districtData = res.district;
          updateCharacterDisplay(res);
        }
      } catch (err) {
        console.error('Failed to refresh player:', err);
      }
    }

    /* ═════════════════════════════════════════════════
       API Fetch Helper
       ═════════════════════════════════════════════════ */
    async function apiFetch(path, options = {}) {
      const headers = { 'Content-Type': 'application/json' };
      if (!options.noAuth && authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }

      const res = await fetch(API_BASE + path, {
        method: options.method || 'GET',
        headers,
        body: options.body || undefined,
      });

      if (res.status === 401) {
        // Token expired or invalid
        localStorage.removeItem('mascodex_token');
        localStorage.removeItem('userToken');
        showLoginGate();
        throw new Error('Unauthorized');
      }

      return res.json();
    }

    /* ═════════════════════════════════════════════════
       Toast Notifications
       ═════════════════════════════════════════════════ */
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      // Remove after animation
      setTimeout(() => {
        if (toast.parentNode) toast.parentNode.removeChild(toast);
      }, 3000);
    }

    /* ═════════════════════════════════════════════════
       Enter key on postal code input
       ═════════════════════════════════════════════════ */
    document.getElementById('postalCodeInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') registerPlayer();
    });
  </script>
</body>
</html>
